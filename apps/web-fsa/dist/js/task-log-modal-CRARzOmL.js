var O=(C,w,m)=>new Promise((g,b)=>{var u=a=>{try{i(m.next(a))}catch(c){b(c)}},f=a=>{try{i(m.throw(a))}catch(c){b(c)}},i=a=>a.done?g(a.value):Promise.resolve(a.value).then(u,f);i((m=m.apply(C,w)).next())});import{$ as s,Z as z,a2 as A,q as G}from"./bootstrap-nS_r6Uzy.js";import{useSocket as J}from"./useSocket-BY-pWA0M.js";import{d as K,r as p,c as S,W as Z,E as P,k as _,K as d,m as r,b as v,x as n,u as t,L,X as U,j as y,l as F,F as X,P as Q,n as Y,V as ee}from"../jse/index-index-BsdptGcH.js";import oe from"./index-QkYnC-9K.js";import le from"./index-BpouPXFr.js";import te from"./index-CGfLNaW6.js";import ae from"./index-Bbbh6CzF.js";import{B as se}from"./index-5sdEDQzI.js";import{S as re}from"./index-BGX4ANgK.js";import{T as ne}from"./index-VWkg5yQM.js";import{u as ue}from"./use-modal-qTZq-J3o.js";import"./useFlexGapSupport-DcJhzveC.js";import"./index-DZFK9PNa.js";import"./Trigger-DmB6V4sb.js";import"./ResizeObserver.es-CDE7jhPe.js";import"./BaseInput-CIdroiOM.js";import"./Overflow-CQR0eu18.js";import"./DownOutlined-Cy6ShKlK.js";import"./CheckOutlined-zUdIMjW3.js";import"./SearchOutlined-8BTzpijE.js";import"./move-k9NGEOQn.js";import"./slide-B2l4e1mx.js";import"./useMergedState-DdQG7FS2.js";import"./FormItemContext-CbGyyj-A.js";import"./statusUtils-DG2SPV6v.js";import"./index-DFgcUpmS.js";import"./EyeOutlined-BiKHx9cD.js";import"./Checkbox-BijoKviF.js";import"./index-DhGJMtpN.js";import"./colors-D59xGIwT.js";import"./index-BMGsZtLz.js";import"./x-BlW8OOV2.js";const ie={class:"task-log-modal"},ce={class:"mb-4"},me={class:"text-sm mb-2"},pe={class:"text-sm"},ve={class:"log-time"},fe={class:"log-message"},de={key:0,class:"log-metadata"},ge={class:"empty-state"},he=K({__name:"task-log-modal",setup(C){const w={info:{color:"blue",text:"INFO"},warn:{color:"orange",text:"WARN"},error:{color:"red",text:"ERROR"},debug:{color:"gray",text:"DEBUG"}},m=p({}),g=S(()=>{var e;return(e=m.value)==null?void 0:e.taskId}),b=S(()=>{var e;return((e=m.value)==null?void 0:e.taskName)||""}),u=p([]),f=p("all"),i=p(""),a=p(!0),c=p(!1),{subscribeTaskLogs:H}=J();let h=null;const k=p(null),x=S(()=>{let e=u.value;if(f.value!=="all"&&(e=e.filter(l=>l.level===f.value)),i.value){const l=i.value.toLowerCase();e=e.filter(o=>o.message.toLowerCase().includes(l)||JSON.stringify(o.metadata||{}).toLowerCase().includes(l))}return e}),D=[{label:s("page.common.all"),value:"all"},{label:"INFO",value:"info"},{label:"WARN",value:"warn"},{label:"ERROR",value:"error"},{label:"DEBUG",value:"debug"}],[E,V]=ue({title:s("page.accountInfo.taskLogs"),class:"w-[900px]",draggable:!0,fullscreenButton:!0,footer:!1,onOpenChange(e){return O(this,null,function*(){if(e){if(m.value=V.getData()||{},u.value=[],f.value="all",i.value="",c.value=!0,g.value)try{console.log("开始订阅任务日志:",g.value),h=H(g.value,$),c.value=!1}catch(l){console.error("订阅任务日志失败:",l),c.value=!1}}else h&&(h(),h=null)})}});function $(e){if(console.log("收到日志更新:",e),e.taskId===g.value){if(u.value.push(...e.logs),console.log("当前日志总数:",u.value.length),u.value.length>500&&(u.value=u.value.slice(-500)),!a.value&&k.value){const o=k.value;o.scrollHeight-o.scrollTop<=o.clientHeight+50||(I.value=!0)}a.value&&requestAnimationFrame(()=>{B()})}}function B(){k.value&&(k.value.scrollTop=k.value.scrollHeight)}function M(){u.value=[]}function j(e){return ee(e).format("HH:mm:ss.SSS")}function W(e){return!e||Object.keys(e).length===0?"":e.progress!==void 0?` [${e.progress}%]`:` ${JSON.stringify(e)}`}const I=p(!1);function q(e){const l=e.target;l.scrollHeight-l.scrollTop<=l.clientHeight+50&&(I.value=!1)}return Z(()=>{h&&h()}),(e,l)=>(_(),P(t(E),null,{default:d(()=>[r("div",ie,[r("div",ce,[r("div",me,n(t(s)("page.accountInfo.taskName"))+": "+n(b.value),1),v(t(oe),{class:"w-full"},{default:d(()=>[v(t(le),{value:f.value,"onUpdate:value":l[0]||(l[0]=o=>f.value=o),options:D,style:{width:"120px"},placeholder:t(s)("page.accountInfo.logLevel")},null,8,["value","placeholder"]),v(t(te).Search,{value:i.value,"onUpdate:value":l[1]||(l[1]=o=>i.value=o),placeholder:t(s)("page.accountInfo.searchLogs"),style:{width:"300px"},"allow-clear":""},null,8,["value","placeholder"]),v(t(ae),{checked:a.value,"onUpdate:checked":l[2]||(l[2]=o=>a.value=o)},{default:d(()=>[L(n(t(s)("page.accountInfo.autoScroll")),1)]),_:1},8,["checked"]),v(t(z),{onClick:M,size:"small"},{default:d(()=>[L(n(t(s)("page.accountInfo.clearDisplay")),1)]),_:1}),l[3]||(l[3]=r("div",{class:"flex-1"},null,-1)),v(t(se),{count:x.value.length,showZero:!0},{default:d(()=>[r("span",pe,n(t(s)("page.accountInfo.logCount")),1)]),_:1},8,["count"])]),_:1})]),v(t(re),{spinning:c.value},{default:d(()=>[r("div",{ref_key:"logContainerRef",ref:k,class:"log-container",onScroll:q},[U(r("div",null,[(_(!0),y(X,null,Q(x.value,(o,N)=>{var R;return _(),y("div",{key:`${o.timestamp}-${N}`,class:Y(["log-item",{"log-error":o.level==="error","log-warn":o.level==="warn"}])},[r("span",ve,n(j(o.timestamp)),1),v(t(ne),{color:((R=w[o.level])==null?void 0:R.color)||"default",class:"log-level"},{default:d(()=>{var T;return[L(n(((T=w[o.level])==null?void 0:T.text)||o.level.toUpperCase()),1)]}),_:2},1032,["color"]),r("span",fe,[L(n(o.message)+" ",1),o.metadata?(_(),y("span",de,n(W(o.metadata)),1)):F("",!0)])],2)}),128))],512),[[A,x.value.length>0]]),U(r("div",ge,[r("div",null,n(c.value?t(s)("page.accountInfo.loadingLogs"):t(s)("page.accountInfo.noLogs")),1)],512),[[A,x.value.length===0]]),I.value&&!a.value?(_(),y("div",{key:0,class:"new-logs-hint",onClick:B}," ↓ "+n(t(s)("page.accountInfo.newLogs")),1)):F("",!0)],544)]),_:1},8,["spinning"])])]),_:1}))}}),Xe=G(he,[["__scopeId","data-v-ff6bc61a"]]);export{Xe as default};
