var ge=Object.defineProperty,fe=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var J=(g,u,r)=>u in g?ge(g,u,{enumerable:!0,configurable:!0,writable:!0,value:r}):g[u]=r,U=(g,u)=>{for(var r in u||(u={}))ke.call(u,r)&&J(g,r,u[r]);if(V)for(var r of V(u))_e.call(u,r)&&J(g,r,u[r]);return g},I=(g,u)=>fe(g,he(u));var A=(g,u,r)=>new Promise((p,m)=>{var f=d=>{try{L(r.next(d))}catch(S){m(S)}},D=d=>{try{L(r.throw(d))}catch(S){m(S)}},L=d=>d.done?p(d.value):Promise.resolve(d.value).then(f,D);L((r=r.apply(g,u)).next())});import{b1 as t,as as C,bL as w,ch as Ce,bs as we}from"./bootstrap-BJQ4xY_l.js";import{d as xe,l as Se,a as Ee,b as Ae}from"./activity-dN6_do1T.js";import be from"./activity-modal-DVJts2QF.js";import{a4 as Le,P as k,R as Re,a_ as b,k as M,a9 as Te,aa as P,ab as R,ac as s,x as l,aD as v,a7 as i,aj as c,ai as h,av as $,aq as H,F as j,b5 as Ue}from"../jse/index-index-CZjfKQLv.js";import{T as Ie}from"./index-DUDDivtd.js";import q from"./index-NDK5Lrka.js";import Y from"./index-BM9rJksX.js";import{C as F}from"./index-BQkm4ls3.js";import{D as Me}from"./dayjs-BVWThhaN.js";import{P as Ye}from"./index-DSmVy39d.js";import{_ as De}from"./page.vue_vue_type_script_setup_true_lang-B9bC9-VS.js";import{u as Oe}from"./use-modal-DAPfi6Bw.js";import{T as W}from"./index-DLMgysYk.js";import"./form-Dc7pQKZ8.js";import"./use-vben-form-9RyIkVnb.js";import"./index-vlz9cqoy.js";import"./checkbox.vue_vue_type_script_setup_true_lang-obtDsCTt.js";import"./render-content.vue_vue_type_script_lang-DyZFyp8x.js";import"./x-BkBkBKrZ.js";import"./colors--zQ5faGU.js";import"./DownOutlined-DSHotxfp.js";import"./isMobile-8sZ0LT6r.js";import"./FormItemContext-2Feh-36j.js";import"./vnode-D8jwJZNd.js";import"./statusUtils-BafBw23h.js";import"./index-BuC4_ePy.js";import"./index-BeMQm5ge.js";import"./Trigger-5OmG7_kU.js";import"./ResizeObserver.es-CDE7jhPe.js";import"./BaseInput-Rv6b8NC9.js";import"./Overflow-yCxUNdPh.js";import"./index-BGjYeiJD.js";import"./CheckOutlined-vre5dF4J.js";import"./SearchOutlined-9BLVvX1_.js";import"./move-BvB2OTP0.js";import"./slide-Ck_Vj4NP.js";import"./useMergedState-Bh_I602w.js";import"./index-DxP7Q5m2.js";import"./shallowequal-DAHsgHgw.js";import"./_arrayIncludes-B8uzE354.js";import"./index-DvMZm7Iy.js";import"./roundedArrow-EYTrNAJt.js";import"./collapseMotion-BT6S83uu.js";import"./Dropdown-Bp5cfo1-.js";import"./useRefs-bVNVOK4Y.js";import"./hasIn-lNdCFDV4.js";import"./isSymbol-C31Rw1Kw.js";import"./isPlainObject-B1TclPtS.js";import"./index-CLRbUrgD.js";import"./index-C2Zr63jJ.js";import"./index-DXwAwwq7.js";import"./index-CUBibixF.js";import"./responsiveObserve-DoomOr37.js";import"./index-2uLRgq7k.js";import"./Checkbox-DiA9qKvl.js";import"./index-CGIEbGbJ.js";import"./index-DLmHigjb.js";import"./EyeOutlined-DUjoKg0O.js";const ze={class:"p-4"},Ne={class:"mb-4 text-2xl font-bold"},Pe={class:"flex flex-wrap items-center gap-4"},$e={class:"flex items-center"},He={class:"mr-2"},We={class:"flex items-center"},Be={class:"mr-2"},Ve={class:"flex items-center ml-4"},Je={style:{width:"100%",height:"880px"}},je={class:"px-4"},qe={class:"flex justify-between items-center mb-2"},Fe={class:"font-medium"},Ke={key:0,class:"py-4 text-center text-gray-500"},Ge=Le({__name:"index",setup(g){const u=k([]),r=k(!1),p=Re({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:e=>`${t("page.common.total")} ${e} ${t("page.common.items")}`}),m=k({page:1,pageSize:10,brand:void 0,timeRange:void 0}),f=k({}),D=k({}),L=k({}),d=k({}),S=k({}),y=k({}),O=k([]),z=k(!1),[K,N]=Oe({connectedComponent:be,onOpenChange:e=>A(null,null,function*(){if(!e){const a=N.getData();a&&a.operationSuccess&&(yield E())}})}),G={LOREAL:t("page.activity.brandLOREAL"),ESTEE:t("page.activity.brandESTEE"),LOCCITANE:t("page.activity.brandLOCCITANE")},Q={ADMIN:t("page.user.roleAdmin"),VIP:t("page.user.roleVip"),USER:t("page.user.roleUser")};function X(e,a){const n=b(),o=b(e),x=b(a);return n.isBefore(o)?{text:t("page.activity.statusNotStarted"),type:"blue"}:n.isAfter(x)?{text:t("page.activity.statusEnded"),type:"red"}:{text:t("page.activity.statusInProgress"),type:"green"}}function Z(e,a){const o=b(a).format("YYYY.MM");return`${G[e]||e}-${o}`}const ee=[{title:t("page.common.seqNo"),key:"seq",width:60,customRender:({index:e})=>(p.current-1)*p.pageSize+e+1},{title:t("page.activity.name"),key:"name",minWidth:150,customRender:({record:e})=>Z(e.brand,e.startTime)},{title:t("page.activity.startTime"),dataIndex:"startTime",key:"startTime",minWidth:170,customRender:({text:e})=>b(e).format("YYYY-MM-DD HH:mm:ss")},{title:t("page.activity.endTime"),dataIndex:"endTime",key:"endTime",minWidth:170,customRender:({text:e})=>b(e).format("YYYY-MM-DD HH:mm:ss")},{title:t("page.activity.status"),key:"status",minWidth:100,customRender:({record:e})=>{const a=X(e.startTime,e.endTime);return M(Ie,{color:a.type},()=>a.text)}},{title:t("page.activity.userCount"),dataIndex:"userCount",key:"userCount",width:120},{title:t("page.activity.taskCount"),dataIndex:"taskCount",key:"taskCount",width:120},{title:t("page.activity.accountInfo"),dataIndex:"accountTotal",key:"accountTotal",width:120,customRender:({record:e})=>`${e.accountTotal}/${e.accountLimitTotal}`},{title:t("page.common.action"),key:"action",minWidth:150}],te=[{title:t("page.user.username"),dataIndex:"username",key:"username",width:120},{title:t("page.user.phone"),dataIndex:"phone",key:"phone",width:120},{title:t("page.user.role"),dataIndex:"role",key:"role",width:100,customRender:({text:e})=>Q[e]||e},{title:t("page.activity.taskCount"),dataIndex:"taskCount",key:"taskCount",width:100},{title:t("page.activity.accountTotal"),key:"accountInfo",width:120,customRender:({record:e})=>`${e.accountCount}`},{title:t("page.activity.accountLimit"),dataIndex:"accountLimit",key:"accountLimit",width:120,customRender:({text:e,record:a,index:n})=>{const o=a._activityId;return d.value[o]?M(q,{value:e,min:1,style:{width:"100px"},onChange:x=>{const _=f.value[o];_&&_[n]&&(_[n]=I(U({},_[n]),{accountLimit:x}))}}):e}},{title:t("page.common.action"),key:"action",width:120}],ae=[{title:t("page.user.username"),key:"username",width:120,customRender:({record:e})=>{var n;const a=e._activityId;return M(Y,{value:((n=y.value[a])==null?void 0:n.userId)||null,placeholder:t("page.activity.selectUserPlaceholder"),style:{width:"100%"},options:O.value,loading:z.value,onChange:o=>{y.value[a]||(y.value[a]={userId:null,accountLimit:1}),y.value[a].userId=o}})}},{title:"",key:"spacer1",width:120},{title:"",key:"spacer2",width:100},{title:"",key:"spacer3",width:100},{title:"",key:"spacer4",width:120},{title:t("page.activity.accountLimit"),key:"accountLimit",width:120,customRender:({record:e})=>{var n;const a=e._activityId;return M(q,{value:((n=y.value[a])==null?void 0:n.accountLimit)||1,min:1,style:{width:"100px"},onChange:o=>{y.value[a]||(y.value[a]={userId:null,accountLimit:1}),y.value[a].accountLimit=o}})}},{title:t("page.common.action"),key:"action",width:120,customRender:({record:e})=>{const a=e._activityId;return M(C,{type:"primary",size:"small",onClick:()=>ye(a)},()=>t("page.common.add"))}}];function ie(){N.setState({title:t("page.activity.addActivity")}).setData({activityData:null,isEdit:!1}).open()}function ne(e){N.setState({title:t("page.activity.editActivity")}).setData({activityData:e,isEdit:!0}).open()}function oe(e){return A(this,null,function*(){try{r.value=!0,yield xe(e.id),w.success(t("page.activity.deleteActivitySuccess")),yield E()}catch(a){w.error(t("page.activity.deleteActivityError"))}finally{r.value=!1}})}function E(){return A(this,arguments,function*(e=m.value){try{r.value=!0;const a=yield Se(I(U({},e),{page:p.current||1,pageSize:p.pageSize||10}));u.value=a.list,p.current=a.pagination.current,p.pageSize=a.pagination.pageSize,p.total=a.pagination.total}catch(a){w.error(t("page.activity.fetchActivityListError"))}finally{r.value=!1}})}function B(e){return A(this,null,function*(){if(!(f.value[e]&&!d.value[e]))try{L.value[e]=!0;const n=(yield Ae(e)).users.map(o=>I(U({},o),{_activityId:e,phone:o.phone||"",role:o.role||"USER"}));f.value[e]=n,D.value[e]=JSON.parse(JSON.stringify(n)),y.value[e]||(y.value[e]={userId:null,accountLimit:1})}catch(a){w.error(t("page.activity.fetchActivityUsersError"))}finally{L.value[e]=!1}})}function se(){return A(this,null,function*(){if(!(O.value.length>0))try{z.value=!0;const e=yield Ce({all:!0});O.value=e.list.map(a=>({label:`${a.username} (${a.phone})`,value:a.id}))}catch(e){w.error(t("page.user.fetchUserListError"))}finally{z.value=!1}})}function re(e){p.current=e.current,p.pageSize=e.pageSize,E()}function le(e,a){e&&(B(a.id),se())}function ce(){if(p.current=1,m.value.timeRange&&m.value.timeRange.length===2){const e=[b(m.value.timeRange[0]).startOf("day").format("YYYY-MM-DD HH:mm:ss"),b(m.value.timeRange[1]).endOf("day").format("YYYY-MM-DD HH:mm:ss")],a=I(U({},m.value),{timeRange:e});E(a)}else E()}function ue(){m.value={page:1,pageSize:10,brand:void 0,timeRange:void 0},p.current=1,E()}function de(e){d.value[e]=!0}function pe(e){f.value[e]=JSON.parse(JSON.stringify(D.value[e])),d.value[e]=!1,y.value[e]={userId:null,accountLimit:1}}function me(e){return A(this,null,function*(){var n;const a=((n=f.value[e])==null?void 0:n.map(o=>({userId:o.userId,accountLimit:o.accountLimit})))||[];try{S.value[e]=!0,yield Ee(e,{users:a}),w.success(t("page.activity.updateLinksSuccess")),d.value[e]=!1,yield B(e),yield E()}catch(o){w.error(t("page.activity.updateLinksError"))}finally{S.value[e]=!1}})}function ve(e,a){f.value[e].splice(a,1)}function ye(e){var _;const{userId:a,accountLimit:n}=y.value[e];if(!a){w.warning(t("page.activity.selectUserWarning"));return}if(f.value[e].find(T=>T.userId===a)){w.warning(t("page.activity.userAlreadyExistsWarning"));return}const x=O.value.find(T=>T.value===a);if(!x){w.warning(t("page.activity.userNotFoundWarning"));return}f.value[e].push({userId:a,username:x.label.split(" ")[0],phone:(_=x.label.split("(")[1])==null?void 0:_.replace(")",""),role:"USER",accountLimit:n,accountCount:0,taskCount:0,_activityId:e}),y.value[e]={userId:null,accountLimit:1}}return Te(()=>A(null,null,function*(){yield E()})),(e,a)=>(R(),P(i(De),null,{default:s(()=>[l(i(K)),v("div",ze,[v("h1",Ne,c(i(t)("page.activity.title")),1),l(i(F),{bordered:!1,class:"mb-4"},{default:s(()=>[v("div",Pe,[v("div",$e,[v("span",He,c(i(t)("page.activity.brand")),1),l(i(Y),{value:m.value.brand,"onUpdate:value":a[0]||(a[0]=n=>m.value.brand=n),placeholder:i(t)("page.activity.brandPlaceholder"),style:{width:"120px"},allowClear:""},{default:s(()=>[l(i(Y).Option,{value:"LOREAL"},{default:s(()=>[h(c(i(t)("page.activity.brandLOREAL")),1)]),_:1}),l(i(Y).Option,{value:"ESTEE"},{default:s(()=>[h(c(i(t)("page.activity.brandESTEE")),1)]),_:1}),l(i(Y).Option,{value:"LOCCITANE"},{default:s(()=>[h(c(i(t)("page.activity.brandLOCCITANE")),1)]),_:1})]),_:1},8,["value","placeholder"])]),v("div",We,[v("span",Be,c(i(t)("page.activity.timeRange")),1),l(i(Me).RangePicker,{value:m.value.timeRange,"onUpdate:value":a[1]||(a[1]=n=>m.value.timeRange=n),placeholder:[i(t)("page.activity.startTimePlaceholder"),i(t)("page.activity.endTimePlaceholder")],style:{width:"280px"},format:"YYYY-MM-DD"},null,8,["value","placeholder"])]),v("div",Ve,[l(i(C),{type:"primary",onClick:ce,class:"mr-2"},{default:s(()=>[h(c(i(t)("page.common.search")),1)]),_:1}),l(i(C),{onClick:ue},{default:s(()=>[h(c(i(t)("page.common.clear")),1)]),_:1})])])]),_:1}),l(i(F),{bordered:!1},{extra:s(()=>[l(i(C),{type:"primary",onClick:ie},{default:s(()=>[h(c(i(t)("page.activity.addActivity")),1)]),_:1})]),default:s(()=>[v("div",Je,[l(i(W),{columns:ee,dataSource:u.value,pagination:p,loading:r.value,rowKey:"id",scroll:{y:750},onChange:re,onExpand:le},{expandColumnTitle:s(()=>[v("span",null,c(i(t)("page.activity.linkUsers")),1)]),expandedRowRender:s(({record:n})=>{var o;return[v("div",je,[v("div",qe,[v("div",Fe,c(i(t)("page.activity.linkUsersDescription")),1),v("div",null,[d.value[n.id]?(R(),$(j,{key:1},[l(i(C),{type:"primary",size:"small",onClick:()=>me(n.id),class:"mr-2",loading:S.value[n.id]},{default:s(()=>[h(c(i(t)("page.common.save")),1)]),_:2},1032,["onClick","loading"]),l(i(C),{size:"small",onClick:()=>pe(n.id)},{default:s(()=>[h(c(i(t)("page.common.cancel")),1)]),_:2},1032,["onClick"])],64)):(R(),P(i(C),{key:0,type:"primary",size:"small",onClick:()=>de(n.id),class:"mr-2"},{default:s(()=>[h(c(i(t)("page.common.edit")),1)]),_:2},1032,["onClick"]))])]),l(i(W),{columns:te,dataSource:f.value[n.id]||[],loading:L.value[n.id]||S.value[n.id],pagination:!1,size:"small",rowKey:"userId",bordered:""},Ue({bodyCell:s(({column:x,record:_,index:T})=>[x.key==="action"&&d.value[_._activityId]?(R(),P(i(Ye),{key:0,title:i(t)("page.common.confirmDelete"),onConfirm:()=>ve(_._activityId,T)},{default:s(()=>[l(i(C),{type:"link",danger:"",size:"small"},{default:s(()=>[h(c(i(t)("page.common.delete")),1)]),_:1})]),_:2},1032,["title","onConfirm"])):H("",!0)]),_:2},[d.value[n.id]?{name:"footer",fn:s(()=>[l(i(W),{columns:ae,dataSource:[{_activityId:n.id}],pagination:!1,size:"small",showHeader:!1,bordered:""},null,8,["dataSource"])]),key:"0"}:void 0]),1032,["dataSource","loading"]),((o=f.value[n.id])==null?void 0:o.length)===0?(R(),$("div",Ke,c(i(t)("page.activity.noLinkedUsers")),1)):H("",!0)])]}),bodyCell:s(({column:n,record:o})=>[n.key==="action"?(R(),$(j,{key:0},[l(i(C),{type:"link",onClick:()=>ne(o)},{default:s(()=>[h(c(i(t)("page.common.edit")),1)]),_:2},1032,["onClick"]),l(i(C),{type:"link",danger:"",onClick:()=>oe(o)},{default:s(()=>[h(c(i(t)("page.common.delete")),1)]),_:2},1032,["onClick"])],64)):H("",!0)]),_:1},8,["dataSource","pagination","loading"])])]),_:1})])]),_:1}))}}),aa=we(Ge,[["__scopeId","data-v-3de2d37a"]]);export{aa as default};
