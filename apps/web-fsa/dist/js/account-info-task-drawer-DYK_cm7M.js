var n=(r,p,m)=>new Promise((a,T)=>{var b=l=>{try{v(m.next(l))}catch(S){T(S)}},g=l=>{try{v(m.throw(l))}catch(S){T(S)}},v=l=>l.done?a(l.value):Promise.resolve(l.value).then(b,g);v((m=m.apply(r,p)).next())});import{bR as _,b1 as t,as as F,bL as c,bs as ae}from"./bootstrap-BJQ4xY_l.js";import{a4 as te,P as f,R as se,a_ as Y,J as R,a9 as oe,aa as q,ab as k,ac as d,aD as D,x as u,a7 as s,aj as h,av as C,aq as $,F as B,ai as P,ad as H}from"../jse/index-index-CZjfKQLv.js";import{u as le}from"./use-drawer-hiZMEC5_.js";import{F as re,a as N,U as ie}from"./index-eYfZyN2x.js";import{C as L}from"./index-BQkm4ls3.js";import U from"./index-CjT6xfb1.js";import{D as de}from"./dayjs-BVWThhaN.js";import ue from"./index-NDK5Lrka.js";import{T as ne}from"./index-DLMgysYk.js";function ce(r){return n(this,null,function*(){const p=new FormData;return p.append("productsFile",r),_.post("/tasks/parseproducts",p,{headers:{"Content-Type":"multipart/form-data"}})})}function pe(r){return n(this,null,function*(){return _.post("/tasks/create",r)})}function me(r,p){return n(this,null,function*(){return _.post(`/tasks/${r}/update`,p)})}function Me(r,p){return n(this,null,function*(){return _.post(`/tasks/${r}/copy`,p)})}function $e(r){return n(this,null,function*(){return _.post(`/tasks/${r}/delete`)})}function Be(r){return n(this,null,function*(){return _.post(`/tasks/${r}/start`)})}function He(r){return n(this,null,function*(){return _.post(`/tasks/${r}/cancel`)})}const fe={class:"p-6"},ke={class:"grid grid-cols-2 gap-6 mb-4"},ge={class:"mt-1 text-xs text-gray-500"},ve={class:"grid grid-cols-2 gap-6"},ye={key:1},he={class:"mt-1 text-xs text-gray-500"},be={key:0,class:"mb-4"},De={class:"mt-2 text-xs text-gray-500"},_e={key:2,class:"text-center text-gray-500 py-8"},Te={class:"flex justify-end gap-3"},Se=te({__name:"account-info-task-drawer",setup(r){const[p,m]=le({onCancel(){m.close()},onOpenChange(o){if(o){const e=m.getData();e&&(g.value=e.isEdit||!1,v.value=e.isView||!1,l.value=e.taskData||void 0,S.value=e.accountId||null,A.value=e.activityId||null,I.value=e.activityStartTime||null,(g.value||v.value)&&l.value?(a.ordersDelay=l.value.ordersDelay||1,a.isScheduled=l.value.isScheduled||!1,a.startTime=l.value.startTime?Y(l.value.startTime):void 0,a.isPolling=l.value.isPolling||!1,a.products=l.value.products?[...l.value.products]:[]):z())}}}),a=se({ordersDelay:1,isScheduled:!1,startTime:void 0,isPolling:!1,products:[]}),T=f(),b=f(!1),g=f(!1),v=f(!1),l=f(void 0),S=f(null),A=f(null),I=f(null),w=f(!1),M=f([]),V=[{title:t("page.common.seqNo"),key:"seq",width:80,customRender:({index:o})=>o+1},{title:t("page.task.productCode"),dataIndex:"skuCode",key:"skuCode",width:160},{title:t("page.task.productName"),dataIndex:"productName",key:"productName",width:200,ellipsis:!0},{title:t("page.task.quantity"),dataIndex:"quantity",key:"quantity",width:100},{title:t("page.task.order"),key:"order",width:80,customRender:({record:o})=>o.order||"-"}],O={ordersDelay:[{required:!0,message:t("page.task.ordersDelayRequired")}]},j=o=>o&&o.isBefore(Y().startOf("day"));function z(){var o;a.ordersDelay=1,a.isScheduled=!1,a.startTime=void 0,a.isPolling=!1,a.products=[],(o=T.value)==null||o.resetFields()}function J(){return n(this,null,function*(){try{if(yield T.value.validate(),a.products.length===0){c.warning(t("page.task.productRequired"));return}for(let o=0;o<a.products.length;o++){const e=a.products[o];if(!(e!=null&&e.skuCode)||!e.skuCode.trim()){c.warning(t("page.task.productCodeRequired",{index:o+1}));return}if(!(e!=null&&e.quantity)||e.quantity<=0){c.warning(t("page.task.productQuantityRequired",{index:o+1}));return}}if(b.value=!0,g.value&&l.value){const o={ordersDelay:a.ordersDelay,isScheduled:a.isScheduled,startTime:a.isScheduled&&a.startTime?a.startTime.format("YYYY-MM-DD HH:mm:ss"):void 0,isPolling:a.isPolling,products:a.products.map((e,i)=>({skuCode:e.skuCode.trim(),productName:e.productName||"",quantity:e.quantity,order:e.order||i+1}))};yield me(l.value.id,o),c.success(t("page.task.updateSuccess"))}else{const o={accountId:S.value,activityId:A.value,ordersDelay:a.ordersDelay,isScheduled:a.isScheduled,startTime:a.isScheduled&&a.startTime?a.startTime.format("YYYY-MM-DD HH:mm:ss"):void 0,isPolling:a.isPolling,products:a.products.map((e,i)=>({skuCode:e.skuCode.trim(),productName:e.productName||"",quantity:e.quantity,order:e.order||i+1}))};yield pe(o),c.success(t("page.task.createSuccess"))}m.setData({operationSuccess:!0}),m.close()}catch(o){c.error(g.value?t("page.task.updateError"):t("page.task.createError"))}finally{b.value=!1}})}const K=R(()=>({type:"primary",loading:b.value,disabled:b.value})),Q=R(()=>({disabled:b.value})),y=R(()=>v.value);function G(){m.close()}oe(()=>{});function W(o){return o.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?o.size/1024/1024<10?!0:(c.error(t("page.task.fileSizeError")),!1):(c.error(t("page.task.excelFormatError")),!1)}function X(o){return n(this,null,function*(){const{file:e,fileList:i}=o;if(M.value=i,e.status==="uploading"){w.value=!0;return}e.status==="done"?(w.value=!1,c.success(`${e.name} ${t("page.task.uploadSuccess")}`),e.response&&e.response.products&&(a.products=e.response.products.map(x=>({skuCode:x.skuCode,quantity:x.quantity,productName:x.productName,order:x.order})),c.success(t("page.task.parseSuccess",{count:a.products.length})))):e.status==="error"&&(w.value=!1,c.error(`${e.name} ${t("page.task.uploadError")}`))})}function Z(o){return n(this,null,function*(){const{file:e,onSuccess:i,onError:x,onProgress:we}=o;try{const E=yield ce(e);i(E)}catch(E){x(E)}})}function ee(o){const e=!!o;a.isScheduled=e,e&&I.value?a.startTime=Y(I.value):e||(a.startTime=void 0)}return(o,e)=>(k(),q(s(p),{title:v.value?s(t)("page.task.viewTask"):g.value?s(t)("page.task.editTask"):s(t)("page.task.createTask")},{footer:d(()=>[D("div",Te,[u(s(F),H(Q.value,{onClick:G}),{default:d(()=>[P(h(y.value?s(t)("page.common.close"):s(t)("page.common.cancel")),1)]),_:1},16),y.value?$("",!0):(k(),q(s(F),H({key:0},K.value,{onClick:J}),{default:d(()=>[P(h(g.value?s(t)("page.common.update"):s(t)("page.common.save")),1)]),_:1},16))])]),default:d(()=>[D("div",fe,[u(s(re),{ref_key:"formRef",ref:T,model:a,rules:O,layout:"vertical"},{default:d(()=>[u(s(L),{title:s(t)("page.task.basicSettings"),class:"mb-4"},{default:d(()=>[D("div",ke,[u(s(N),{label:s(t)("page.task.isScheduled"),name:"isScheduled"},{default:d(()=>[u(s(U),{checked:a.isScheduled,"onUpdate:checked":e[0]||(e[0]=i=>a.isScheduled=i),onChange:ee,disabled:y.value},null,8,["checked","disabled"])]),_:1},8,["label"]),u(s(N),{label:s(t)("page.task.isPolling"),name:"isPolling"},{default:d(()=>[u(s(U),{checked:a.isPolling,"onUpdate:checked":e[1]||(e[1]=i=>a.isPolling=i),disabled:y.value},null,8,["checked","disabled"]),D("div",ge,h(s(t)("page.task.pollingDescription")),1)]),_:1},8,["label"])]),D("div",ve,[a.isScheduled?(k(),q(s(N),{key:0,label:s(t)("page.task.startTime"),name:"startTime"},{default:d(()=>[u(s(de),{value:a.startTime,"onUpdate:value":e[2]||(e[2]=i=>a.startTime=i),format:"YYYY-MM-DD HH:mm:ss","disabled-date":j,"show-time":{format:"HH:mm:ss"},placeholder:s(t)("page.task.startTimePlaceholder"),style:{width:"280px"},disabled:y.value},null,8,["value","placeholder","disabled"])]),_:1},8,["label"])):(k(),C("div",ye)),u(s(N),{label:s(t)("page.task.ordersDelay"),name:"ordersDelay"},{default:d(()=>[u(s(ue),{value:a.ordersDelay,"onUpdate:value":e[3]||(e[3]=i=>a.ordersDelay=i),min:1,max:6e4,step:1,style:{width:"200px"},placeholder:s(t)("page.task.ordersDelayPlaceholder"),disabled:y.value},null,8,["value","placeholder","disabled"]),D("div",he,h(s(t)("page.task.ordersDelayDescription")),1)]),_:1},8,["label"])])]),_:1},8,["title"]),u(s(L),{title:s(t)("page.task.productSettings"),class:"mb-4"},{default:d(()=>[y.value?$("",!0):(k(),C("div",be,[u(s(ie),{fileList:M.value,"before-upload":W,"custom-request":Z,onChange:X,accept:".xlsx",multiple:!1,"max-count":1},{default:d(()=>[u(s(F),{type:"dashed",loading:w.value,style:{width:"100%"}},{default:d(()=>[w.value?(k(),C(B,{key:0},[P(h(s(t)("page.task.uploading")),1)],64)):(k(),C(B,{key:1},[P(h(s(t)("page.task.uploadExcel")),1)],64))]),_:1},8,["loading"])]),_:1},8,["fileList"]),D("div",De,h(s(t)("page.task.fileFormat")),1)])),a.products.length>0?(k(),q(s(ne),{key:1,columns:V,dataSource:a.products,pagination:!1,size:"small",bordered:"",rowKey:"skuCode"},null,8,["dataSource"])):(k(),C("div",_e,h(y.value?s(t)("page.task.noProductData"):s(t)("page.task.uploadExcelPrompt")),1))]),_:1},8,["title"])]),_:1},8,["model"])])]),_:1},8,["title"]))}}),xe=ae(Se,[["__scopeId","data-v-2a60b16c"]]),Le=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"}));export{xe as A,Me as a,Le as b,He as c,$e as d,Be as s};
